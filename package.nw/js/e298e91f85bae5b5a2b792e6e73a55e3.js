'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('mkdir-p'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./5321b622f9bab971490e99e09b2389a9.js'),f=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),g=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),h=require('./3e74bc0c6a5fa450386148788cc0cf44.js'),i=require('./db2217eb4cff896bdcbc50abe005058f.js'),j=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),k=require('./874074ba4ecebc4e49310ccc42243ff5.js'),l=require('./19404cae4023ed740f4fe4bce92ebf66.js'),m=require('./3bfffbe88b3d923921f851c0697974fe.js'),n=require('./3892cb9d0783075a973c350c41401370.js'),o=()=>{},p=(d,e)=>{for(let f,g=0,h=e.length;g<h;g++)f=b.join(d,e[g].FunctionName),a.existsSync(f)||c.sync(f)},q=async(a)=>{const b=m.getCurrentTcbInfo();let c=b.currentEnv&&b.currentEnv.namespace;if(c)return c;let d,e=(await r()(a))||[];if(0>=e.length)(d=i.get(j.WINDOW_REGISTRY.CLOUD_CONSOLE))?d.focus():a({type:f.WINDOW_SET_CLOUD,data:{console:{show:!0}}});else{if(1==e.length)return a(s(0)),c=e[0].namespace,c;(d=i.get(j.WINDOW_REGISTRY.CLOUD_SCF_ACTION))?d.focus():a({type:f.WINDOW_SET_CLOUD,data:{fnaction:{show:!0},cloudfunctionRoot:{show:!0}}})}},r=()=>{return async(a)=>{try{let b=await h.getEnvList();return a({type:f.TCB_SET_ENV_LIST,data:b.env_list}),b.env_list}catch(b){a({type:f.INFO_SHOW_ERROR,data:{message:b.toString()}})}}},s=(a)=>{return{type:f.TCB_SELECT_ENV,data:a}},t=(a)=>{return async(c,d)=>{try{let g=await q(c,d);if(!g)return;const i=d(),j=i.project.current||{},k=b.join(j.projectpath,j.cloudfunctionRoot);a.showTips&&c(A({show:!0,title:'\u6B63\u5728\u540C\u6B65\u4E91\u51FD\u6570\u5217\u8868',content:'',showCancel:!1,showLoading:!0}));let l=`${Date.now()}${Math.random()}`,m=await h.getTcbFuncList({namespace:g,pageIndex:0,pageSize:e.FUNC_LIST_PAGE_SIZE}),n=[].concat(m.Functions);if(a.writeFile&&p(k,m.Functions),c({type:f.TCB_SET_SCF_LIST,data:{list:m.Functions,pageIndex:0,total:m.total,namespace:g,updateKey:l}}),m.total>e.FUNC_LIST_PAGE_SIZE){let b=parseInt((m.total-1)/e.FUNC_LIST_PAGE_SIZE);for(let d,j=1;j<b;j++)d=await h.getTcbFuncList({namespace:g,pageIndex:j,pageSize:e.FUNC_LIST_PAGE_SIZE}),n=n.concat(d.Functions),a.writeFile&&p(k,d.Functions),c({type:f.TCB_SET_SCF_LIST,data:{list:d.Functions,pageIndex:j,total:m.total,namespace:g,updateKey:l}})}return c({type:f.TCB_CLEAN_SCF_LIST,data:{namespace:g,updateKey:l}}),a.showTips&&c(A({show:!0,title:'\u540C\u6B65\u4E91\u51FD\u6570\u5217\u8868\u6210\u529F',content:'',showCancel:!1,showLoading:!1})),n}catch(b){a.showTips&&c(A({show:!0,title:'\u540C\u6B65\u4E91\u51FD\u6570\u5217\u8868\u5931\u8D25',content:b.toString(),showCancel:!1,showLoading:!1}))}}},u=(a)=>{return{type:f.TCB_CONSOLE_COMMAND,data:a}},v=(a)=>{return 1024>a?`${a} B`:1048576>a?`${(a/1024).toFixed(1)} KB`:`${(a/1024/1024).toFixed(1)} MB`},w=(a)=>{let b=[];return a.hasOwnProperty('packSize')&&b.push(`上传包大小：${v(a.packSize)}`),a.hasOwnProperty('filesCount')&&b.push(`文件数量：${a.filesCount}`),b.join('\uFF0C')},x=async(a)=>{return new Promise(async(b,c)=>{let e=!1;const{namespace:f,functionName:g,onStatusUpdate:i=o,maxWaitTimeout:j=900000}=a,k=setTimeout(()=>{e||(e=!0,c(`timeout waiting for function to deploy`))},j);try{let a='';for(const c=+new Date;!e&&+new Date-c<j;){const c=await h.getTcbFuncInfo({namespace:f,functionName:g});switch(global.appConfig.isDev&&console.warn('info for func',g,c),c.Status){case l.FUNCTION_STATUS.Creating:{a!==c.Status&&i(c.Status);break}case l.FUNCTION_STATUS.Updating:{a!==c.Status&&i(c.Status);break}case l.FUNCTION_STATUS.CreateFailed:throw new Error(`创建云函数失败：${c.StatusDesc}`);case l.FUNCTION_STATUS.UpdateFailed:throw new Error(`更新云函数失败：${c.StatusDesc}`);case l.FUNCTION_STATUS.Active:{e=!0,b();break}}}}catch(a){console.trace(),console.error(a);try{d.error(`upload ${f} ${g} failed: `,'string'==typeof a?a:JSON.stringify(a))}catch(a){d.error(`upload ${f} ${g} failed: `,a.toString())}clearTimeout(k),c(a)}})},y=(a)=>{return async(c,d)=>{const e=await q(c,d);if(!e)return;const{dirPath:f,showTips:g,runtime:i,syncFunctions:j,createFunction:k,installDependency:m}=a,n=b.basename(f);try{if(!k){const a=await h.getTcbFuncInfo({namespace:e,functionName:n});let b=m?'TRUE':'FALSE';if(b!==a.InstallDependency){await h.updateTcbFuncConfig({namespace:e,functionName:n,config:{InstallDependency:b}})}}g&&c(A({show:!0,title:`正在${k?'\u521B\u5EFA':'\u4E0A\u4F20'} ${n}`,content:'',showCancel:!1,showLoading:!0}));const a=await h.uploadTcbFunc({functionName:n,dirPath:f,runtime:i,namespace:e,installDependency:m,onStatusUpdate:(b)=>{if(g){let d='';switch(b){case l.IDE_UPLOAD_STATUS.COMPRESSING:{d=`正在压缩打包云函数 ${n} 代码 ...`;break}case l.IDE_UPLOAD_STATUS.UPLOADING:{d=`正在${k?'\u521B\u5EFA':'\u4E0A\u4F20'} ${n}`;break}}c(A({show:!0,title:d,content:w(a),showCancel:!1,showLoading:!0}))}}});if(g){const b=`上传 ${n} 成功 ...`,d={show:!0,title:b,content:w(a),showCancel:!1,showLoading:!0};c(A(d)),await x({namespace:e,functionName:n,onStatusUpdate:(a)=>{let e='';switch(a){case l.FUNCTION_STATUS.Creating:{e=`${b}，正在创建云函数 ...`;break}case l.FUNCTION_STATUS.Updating:{e=`${b}，正在更新云函数 ...`;break}}c(A(_extends({},d,{title:e})))}}),c(A(_extends({},d,{title:`上传并部署 ${n} 完成`,showLoading:!1})))}j&&t({showTips:!1,writeFile:!1})(c,d)}catch(a){g&&c(A({show:!0,title:`${k?'\u521B\u5EFA':'\u4E0A\u4F20'} ${n} 失败`,content:a.toString(),showCancel:!1,showLoading:!1}))}}},z=(d)=>{return async(g,e)=>{const h=d.namespace||(await q(g,e));if(h)try{d.showTips&&g(A({show:!0,title:`正在下载 ${d.functionName}`,content:'',showCancel:!1,showLoading:!0}));let e=await k.getFunctionData({functionName:d.functionName,forceUpdate:!0,namespace:h});if(d.writeFile)for(var i in e){let f=b.join(d.dirPath,i),g=b.dirname(f);c.sync(g),a.writeFileSync(f,e[i])}g({type:f.TCB_SET_FILE,data:{functionName:d.functionName,fileList:Object.keys(e),namespace:h}}),d.showTips&&g(A({show:!0,title:'\u4E0B\u8F7D\u6210\u529F',content:'',showCancel:!1,showLoading:!1}))}catch(a){d.showTips&&g(A({show:!0,title:'\u4E0B\u8F7D\u5931\u8D25',content:a.toString(),showCancel:!1,showLoading:!1}))}}},A=(a)=>{return{type:f.TCB_SET_LOADING,data:a}};module.exports={getEnvList:r,selectEnv:s,getTcbFuncList:t,uploadTcbFunc:y,consoleCommand:u,showActionMsg:(a)=>{return{type:f.TCB_SCF_INFO,data:{show:!0,message:a}}},setConfirmInfo:(a)=>{return{type:f.TCB_SCF_INFO,data:a}},showConsoleAddSCF:()=>{return async(a,b)=>{const c=m.getCurrentTcbInfo(),d=await q(a,b);if(!d)return;let e;(e=i.get(j.WINDOW_REGISTRY.CLOUD_CONSOLE))?e.focus():a({type:f.WINDOW_SET_CLOUD,data:{console:{show:!0}}}),a(u({command:'SHOW_CREATE_SCF',data:{namespace:d,envId:c.currentEnv&&c.currentEnv.id}}))}},downloadTcbFunc:z,downloadAllTcbFunc:(d)=>{return async(g,e)=>{const h=e(),i=h.project.current.cloudfunctionRoot,j=await q(g,e);if(j){d.showTips&&g(A({show:!0,title:'\u6B63\u5728\u4E0B\u8F7D\u8BF7\u7A0D\u7B49',content:'',showCancel:!1,showLoading:!0}));try{const h=(await t(d)(g,e))||[];let m=[];for(let e,n=0,o=h.length;n<o;n++){e=h[n],d.showTips&&g(A({show:!0,title:`正在下载 ${e.FunctionName}`,content:'',showCancel:!1,showLoading:!0}));try{let h=await k.getFunctionData({functionName:e.FunctionName,forceUpdate:d.forceUpdate,namespace:j});if(d.writeFile){let d=b.join(i,e.FunctionName);for(var l in h){let e=b.join(d,l),f=b.dirname(e);c.sync(f),a.writeFileSync(e,h[l])}}g({type:f.TCB_SET_FILE,data:{functionName:e.FunctionName,fileList:Object.keys(h),namespace:j}})}catch(a){m.push(a.toString()),d.showTips&&g(A({show:!0,title:'\u90E8\u5206\u4E0B\u8F7D\u5931\u8D25',content:m.join('\n'),showCancel:!1,showLoading:!0}))}}d.showTips&&g(A({show:!0,title:'\u4E0B\u8F7D\u6210\u529F',content:'',showCancel:!1,showLoading:!1}))}catch(a){d.showTips&&g(A({show:!0,title:'\u4E0B\u8F7D\u5931\u8D25',content:a.toString(),showCancel:!1,showLoading:!1}))}}}},setLoading:A,uploadTcbFunctions:(a)=>{return async(b,c)=>{const d=a.dirPaths;for(let e,f=0;f<d.length;f++)e=d[f],await y({showTips:a.showTips,syncFunctions:!1,dirPath:e})(b,c);t({showTips:!1,writeFile:!1})(b,c)}},downloadTcbFunctions:(a)=>{return async(c,d)=>{for(let e,f=0;f<a.functionNames.length;f++)e=a.functionNames[f],await z(_extends({},a,{dirPath:b.join(a.dirPath,e),functionName:e}))(c,d)}},setCurrentEnv:(a)=>{return async(b)=>{const c=m.getCurrentTcbInfo();let d=c.envList;if(0>=d.length){let a=await h.getEnvList();b({type:f.TCB_SET_SCF_LIST,data:a.env_list}),d=a.env_list}const e=d.findIndex((b)=>{return b.namespace==a});-1!=e&&b(s(e))}}}}(require('lazyload'),require);