'use strict';!function(require,directRequire){function a(a){const b=h.createHash('md5');return b.update(a).digest('hex')}async function b(a,b=()=>{}){return new Promise(async(c,e)=>{try{const e=Date.now(),f=[...a];b('compilejs',l.config.PROCESSING.format(a[0].file));const g=await Promise.all(a.map((a)=>k({taskName:'processJS',config:{projectPath:a.projectPath,file:a.file,es6:a.es6?'yes':'no',minified:a.minified?'yes':'no',sourceMaps:'map',sourceFileName:d.basename(a.file)},dataStr:a.code,maxTimeout:180000,useBackup:!0,downgrade:!1,onAfterRun:()=>{const c=f.findIndex((b)=>b===a);0<=c&&f.splice(c,1),f[0]&&b('compilejs',l.config.PROCESSING.format(f[0].file))}})));console.log(`compilejs all files cost time: ${Date.now()-e}`),c(g)}catch(a){a instanceof Error?e(a):e(new Error(a))}})}const c=require('fs'),d=require('path'),e=require('mkdir-p'),f=require('babel-core'),g=require('uglify-js'),h=require('crypto'),i=require('./162bf2ee28b76d3b3d95b685cede4146.js'),j=require('./48679210e49dc5028a8b6642263eba75.js'),k=require('./41168dca39589e852da6631126d0f94d.js'),l=require('./common/locales/index.js'),m=require('./cdbf7243dc99f8461acbb1d57af1d8ae.js'),{bufToUTF8:n}=require('./efc820e1b92d6e4063535296d4a24213.js'),{FILE_NOT_UTF8:o,BABEL_TRANS_JS_ERR:p,UGLIFY_JS_ERR:q,BABILI_JS_ERR:r}=require('./949d8235c744ced2a80121e4dba34c28.js'),s={};module.exports=function(f,g={}){s[f.hash]||(s[f.hash]={});const h=s[f.hash],k=g.onProgressUpdate||function(){},p=g.onFilesIgnored||function(){};return new Promise(async(q,r)=>{const{es6:s,minified:u,newFeature:t}=f.setting,v=await j(f),w=v.openDataContext||v.subContext,{distPath:x}=g,y=await i(f),z=y.getAllJSFiles();const A=[],B=[];for(let b=0,c=z.length;b<c;b++){const c=z[b],e=w&&0===c.indexOf(w),f=d.normalize(c.replace(/\.js$/,'')),g=y.getFile(c,null),i=n(g);if(void 0===i){const a=new Error(l.config.FILE_NOT_UTF8.format(c));return a.code=o,r(a)}const j=Date.now(),k=a(i),p=`${c}_${s}_${u}`;if(h[p]&&h[p].md5===k)console.log('compile js',c,'in cache, skip.');else if((s||u)&&512000>i.length)A.push({projectPath:y.srcPath,file:c,code:i,es6:s,minified:u,md5:k});else{let a,b=m(d.join(y.srcPath,c),i);if(b)try{'string'==typeof b&&(b=JSON.parse(b)),b=await m.insertSourcesContent(b,d.join(y.srcPath,c)),b=await m.rewriteSourcesIfNeeded(b,'game:///',[c]),a=JSON.stringify(b)}catch(a){b=null}h[`${c}_${s}_${u}`]={md5:k,jsCode:i,map:a||JSON.stringify(b),ignored:(s||u)&&512000<=i.length}}}if(0<A.length){let a=[];try{a=await b(A,k)}catch(a){return r(a)}for(let b=0,c=A.length;b<c;b++){if(a[b].error){const c=a[b].error,d=new Error(c.message);return d.code=c.code,r(d)}const{file:c,md5:e}=A[b];let f=a[b].map;try{'string'==typeof f&&(f=JSON.parse(f)),f=await m.insertSourcesContent(f,d.join(y.srcPath,c)),f=await m.rewriteSourcesIfNeeded(f,'game:///',[c]),f=JSON.stringify(f)}catch(a){f=null}h[`${c}_${s}_${u}`]={md5:e,jsCode:a[b].code,map:f}}}for(let a=0,b=z.length;a<b;a++){const b=z[a],f=d.join(x,b),g=d.dirname(f);e.sync(g);const i=h[`${b}_${s}_${u}`];if(i&&i.jsCode){const a=i.jsCode;c.writeFileSync(f,a),i.ignored&&B.push(b),i.map&&c.writeFileSync(d.join(x,`${b}.map`),i.map)}}p(B),q()})}}(require('lazyload'),require);